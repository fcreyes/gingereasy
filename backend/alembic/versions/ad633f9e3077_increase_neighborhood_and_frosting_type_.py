"""increase_neighborhood_and_frosting_type_limits

Revision ID: ad633f9e3077
Revises:
Create Date: 2025-12-08 02:47:53.407841

"""

from collections.abc import Sequence

import sqlalchemy as sa

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "ad633f9e3077"
down_revision: str | Sequence[str] | None = None
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###

    # All operations wrapped in IF EXISTS/IF NOT EXISTS to handle:
    # - Fresh databases: tables created by create_all() AFTER alembic runs
    # - Existing databases: need to migrate schema
    op.execute("""
        DO $$
        BEGIN
            -- Create users table if it doesn't exist (for existing databases)
            IF NOT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'users') THEN
                CREATE TABLE users (
                    id SERIAL PRIMARY KEY,
                    email VARCHAR(255) NOT NULL UNIQUE,
                    username VARCHAR(100) NOT NULL UNIQUE,
                    hashed_password VARCHAR(255) NOT NULL,
                    is_active INTEGER NOT NULL DEFAULT 1,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                CREATE INDEX ix_users_id ON users(id);
                CREATE INDEX ix_users_email ON users(email);
                CREATE INDEX ix_users_username ON users(username);
            END IF;

            -- Only alter listings table if it exists
            IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'listings') THEN
                -- Increase column sizes (only if they're still the old size)
                IF EXISTS (
                    SELECT FROM information_schema.columns
                    WHERE table_name = 'listings' AND column_name = 'neighborhood'
                    AND character_maximum_length = 100
                ) THEN
                    ALTER TABLE listings ALTER COLUMN neighborhood TYPE VARCHAR(200);
                END IF;

                IF EXISTS (
                    SELECT FROM information_schema.columns
                    WHERE table_name = 'listings' AND column_name = 'frosting_type'
                    AND character_maximum_length = 100
                ) THEN
                    ALTER TABLE listings ALTER COLUMN frosting_type TYPE VARCHAR(500);
                END IF;

                -- Add owner_id column if it doesn't exist
                IF NOT EXISTS (
                    SELECT FROM information_schema.columns
                    WHERE table_name = 'listings' AND column_name = 'owner_id'
                ) THEN
                    ALTER TABLE listings ADD COLUMN owner_id INTEGER REFERENCES users(id);
                END IF;

                -- Update NULL values to defaults before adding NOT NULL constraints
                UPDATE listings SET has_gumdrop_garden = 0 WHERE has_gumdrop_garden IS NULL;
                UPDATE listings SET listing_type = 'cottage' WHERE listing_type IS NULL;
                UPDATE listings SET status = 'available' WHERE status IS NULL;

                -- Add NOT NULL constraints (only if not already set)
                ALTER TABLE listings ALTER COLUMN has_gumdrop_garden SET NOT NULL;
                ALTER TABLE listings ALTER COLUMN listing_type SET NOT NULL;
                ALTER TABLE listings ALTER COLUMN status SET NOT NULL;
            END IF;

            -- Only alter users table if it exists and needs updates
            IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'users') THEN
                UPDATE users SET is_active = 1 WHERE is_active IS NULL;
                -- Ensure is_active is NOT NULL
                ALTER TABLE users ALTER COLUMN is_active SET NOT NULL;
            END IF;
        END $$;
    """)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column("users", "is_active", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("listings", "status", existing_type=sa.VARCHAR(length=50), nullable=True)
    op.alter_column("listings", "listing_type", existing_type=sa.VARCHAR(length=50), nullable=True)
    op.alter_column(
        "listings",
        "frosting_type",
        existing_type=sa.String(length=500),
        type_=sa.VARCHAR(length=100),
        existing_nullable=True,
    )
    op.alter_column("listings", "has_gumdrop_garden", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column(
        "listings",
        "neighborhood",
        existing_type=sa.String(length=200),
        type_=sa.VARCHAR(length=100),
        existing_nullable=True,
    )
    # ### end Alembic commands ###
